#
# .bash_prompt -- configure fancy bash prompt
#

if [[ ${BASH_VERSINFO[0]} -ge 4 ]]; then
  declare -A aws_region=( 
    [us-west-2]=usw2
    [us-west-1]=usw1
    [us-east-2]=use2
    [us-east-1]=use1
    [ca-central-1]=ca
    [eu-west-1]=euw1
    [eu-central-1]=euc1
  )
fi

GITAWAREPROMPT="$HOME/.homesick/repos/git-aware-prompt"
if [[ -d $GITAWAREPROMPT ]]; then
  #export GITAWAREPROMPT
  #source "${GITAWAREPROMPT}/main.sh"
  # we only want the color variables, not the prompt.
  # can't use bash-git-prompt colors: https://github.com/magicmonty/bash-git-prompt/pull/470
  source "${GITAWAREPROMPT}/colors.sh"
fi

# In a git repo, bash-git-prompt's prompt magic replaces PS1 with
# its own thing, but if GIT_PROMPT_START and GIT_PROMPT_END are defined
# then it replaces PS1 with:
#
#   ${GIT_PROMPT_START}[...the git status...]${GIT_PROMPT_END}
#
# Since I want the status in the middle of my usual prompt, let's build PS1
# using GIT_PROMPT_START and _END rather than having to build both.

if [[ "$TERM" = "xterm" || "$TERM" = "xterm-color" || \
      "$TERM" = "rxvt"  || "$TERM" = "xterm-256color" ]]; then
  WINDOW_TITLE='\[\033]0;\u@\h: \w\007\]'
fi

if [[ $SSH_CONNECTION ]]; then
  HOSTNAME_PROMPT="\[${txtcyn}\]\h\[${txtwht}\]:"
fi

function prompt_face {
  case $? in
    0) echo -ne "\001${txtcyn}\002:)" ;;
    *) echo -ne "\001${txtred}\002:(" ;;
  esac
  echo -ne "\001${txtrst}\002"
}

function prompt_user {
  local output_user

  case $USER in
    root)           output_user="\001${bldred}\002root\001${txtrst}\002" ;;
    rich|rlafferty) output_user="" ;;
    *)              output_user="\001${txtpur}\002${USER}\001${txtrst}\002" ;;
  esac

  if [[ $HOSTNAME_PROMPT && $output_user ]]; then
    echo -ne "${output_user}@"
  elif [[ $output_user ]]; then
    echo -ne "${output_user}:"
  fi
}

function prompt_aws {
  aws_account=${AWS_VAULT:-$AWS_OKTA_PROFILE}

  if [[ $aws_account ]]; then
    if [[ $AWS_DEFAULT_REGION && ${aws_region[$AWS_DEFAULT_REGION]} ]]; then
      prompt_region=${aws_region[$AWS_DEFAULT_REGION]}
    else
      prompt_region=$AWS_DEFAULT_REGION
    fi

    echo -ne "\001$txtcyn\002(\001$txtylw\002${aws_account}@${prompt_region}\001$txtcyn\002)"
  fi
}

# single quotes around function calls means they're called at each prompt
GIT_PROMPT_START="${WINDOW_TITLE}"'$(prompt_face) $(prompt_user)'"${HOSTNAME_PROMPT}\[${txtcyn}\]\W\[${txtrst}\]"
GIT_PROMPT_END='$(prompt_aws)'"\[$txtwht\]\\$\[$txtrst\] "

PS1="${GIT_PROMPT_START}${GIT_PROMPT_END}"

export PS1 GIT_PROMPT_START GIT_PROMPT_END

if [[ -d ~/.homesick/repos/bash-git-prompt ]]; then
  GIT_PROMPT_ONLY_IN_REPO=1
  source ~/.homesick/repos/bash-git-prompt/gitprompt.sh
fi

export MYSQL_PS1="\u@\h:\d> "
