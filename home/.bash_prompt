#
# .bash_prompt -- configure fancy bash prompt
#

GITAWAREPROMPT="$HOME/.homesick/repos/git-aware-prompt"
if [[ -d $GITAWAREPROMPT ]]; then
  #export GITAWAREPROMPT
  #source "${GITAWAREPROMPT}/main.sh"
  # we only want the color variables, not the prompt.
  # can't use bash-git-prompt colors: https://github.com/magicmonty/bash-git-prompt/pull/470
  source "${GITAWAREPROMPT}/colors.sh"
fi

# In a git repo, bash-git-prompt's prompt magic replaces PS1 with
# its own thing, but if GIT_PROMPT_START and GIT_PROMPT_END are defined
# then it replaces PS1 with:
#
#   ${GIT_PROMPT_START}[...the git status...]${GIT_PROMPT_END}
#
# Since I want the status in the middle of my usual prompt, let's build PS1
# using GIT_PROMPT_START and _END rather than having to build both.

if [[ "$TERM" = "xterm" || "$TERM" = "xterm-color" || \
      "$TERM" = "rxvt"  || "$TERM" = "xterm-256color" ]]; then
  WINDOW_TITLE='\[\033]0;\u@\h: \w\007\]'
fi

if [[ $SSH_CONNECTION ]]; then
  HOSTNAME_PROMPT="\[${txtcyn}\]\h\[${txtwht}\]:"
fi

if [[ $AWS_VAULT || $AWS_OKTA_PROFILE ]]; then
  AWS_ACCOUNT_PROMPT="\[$txtcyn\](\[$txtylw\]${AWS_VAULT:-$AWS_OKTA_PROFILE}\[$txtcyn\])"
fi

function prompt_face {
  if [[ $? -eq 0 ]]; then
    echo -ne "\001${txtcyn}\002:)\001${txtrst}\002"
  else
    echo -ne "\001${txtred}\002:(\001${txtrst}\002"
  fi
}

function prompt_user {
  local output_user

  if [[ "$USER" = 'root' ]]; then
    output_user=1
    echo -ne "\001${bldred}\002root\001${txtrst}\002"
  elif [[ "$USER" != "rich" && "$USER" != "rlafferty" ]]; then
    output_user=1
    echo -ne "\001${txtpur}\002${USER}\001${txtrst}\002"
  fi

  if [[ $HOSTNAME_PROMPT && $output_user ]]; then
    echo -n "@"
  elif [[ $output_user ]]; then
    echo -n " "
  fi
}

# single quotes around function calls means they're called at each prompt
GIT_PROMPT_START="${WINDOW_TITLE}"'$(prompt_face) $(prompt_user)'"${HOSTNAME_PROMPT}\[${txtcyn}\]\W\[${txtrst}\]"
GIT_PROMPT_END="${AWS_ACCOUNT_PROMPT}\[$txtwht\]\\$\[$txtrst\] "

PS1="${GIT_PROMPT_START}${GIT_PROMPT_END}"

export PS1 GIT_PROMPT_START GIT_PROMPT_END

if [[ -d ~/.homesick/repos/bash-git-prompt ]]; then
  GIT_PROMPT_ONLY_IN_REPO=1
  source ~/.homesick/repos/bash-git-prompt/gitprompt.sh
fi

export MYSQL_PS1="\u@\h:\d> "
